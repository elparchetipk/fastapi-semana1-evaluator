---
name: 🔄 Re-evaluación Masiva

on:
  workflow_dispatch:
    inputs:
      week:
        description: 'Semana a re-evaluar (1-11)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - '10'
          - '11'
      label_filter:
        description: 'Filtrar por label adicional (opcional)'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Modo de prueba (no actualizar issues)'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  mass-reevaluate:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Checkout repositorio evaluador
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: 📦 Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔍 Buscar issues para re-evaluar
        id: find_issues
        uses: actions/github-script@v7
        with:
          script: |
            const week = '${{ inputs.week }}';
            const labelFilter = '${{ inputs.label_filter }}';
            const dryRun = '${{ inputs.dry_run }}' === 'true';

            // Buscar issues con los labels apropiados
            const labels = [`evaluacion`, `semana-${week}`];
            if (labelFilter) {
              labels.push(labelFilter);
            }

            console.log(`Buscando issues con labels: ${labels.join(', ')}`);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels.join(','),
              state: 'open',
              per_page: 100
            });

            console.log(`Encontrados ${issues.data.length} issues para re-evaluar`);

            if (dryRun) {
              console.log('MODO DE PRUEBA - No se realizarán cambios');
              for (const issue of issues.data) {
                console.log(`- Issue #${issue.number}: ${issue.title}`);
              }
              return;
            }

            // Procesar cada issue
            for (const issue of issues.data) {
              console.log(`Procesando issue #${issue.number}: ${issue.title}`);
              
              // Agregar un comentario para activar la re-evaluación
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `🔄 **Re-evaluación automática activada**\n\n` +
                      `Esta evaluación fue iniciada por el workflow de re-evaluación masiva.\n\n` +
                      `/evaluar`
              });
              
              // Esperar un poco entre requests para evitar rate limiting
              await new Promise(resolve => setTimeout(resolve, 1000));
            }

            console.log(`✅ Re-evaluación completada para ${issues.data.length} issues`);

      - name: 📊 Reporte final
        run: |
          echo "::notice title=Re-evaluación Masiva::Completada para semana ${{ inputs.week }}"
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "::warning title=Modo de Prueba::No se realizaron cambios reales"
          fi

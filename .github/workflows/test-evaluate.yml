---
name: ü§ñ Evaluaci√≥n Autom√°tica (Test Mode)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  evaluate:
    runs-on: ubuntu-latest

    # Modo test: solo verificar comando /evaluar
    if: |
      github.event_name == 'issue_comment' && 
      (contains(github.event.comment.body, '/evaluar') || 
       contains(github.event.comment.body, '/test-evaluar'))

    steps:
      - name: üöÄ Checkout repositorio evaluador
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Extraer informaci√≥n del issue
        id: extract_info
        run: |
          echo "=== DEBUGGING WORKFLOW ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Issue labels: ${{ toJson(github.event.issue.labels) }}"
          echo "Comment body: ${{ github.event.comment.body }}"

          # Extraer URL del repositorio del cuerpo del issue
          REPO_URL=$(echo "${{ github.event.issue.body }}" | \
            grep -oE 'https://github\.com/[^][:space:]]*' | head -1)

          # Si no hay URL en el issue, intentar del comentario
          if [[ -z "$REPO_URL" ]]; then
            REPO_URL=$(echo "${{ github.event.comment.body }}" | \
              grep -oE 'https://github\.com/[^][:space:]]*' | head -1)
          fi

          # URL por defecto para testing
          if [[ -z "$REPO_URL" ]]; then
            REPO_URL="https://github.com/leorodrivi/2766065-jjuradoq-fastapi-semana1"
          fi

          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "Found repository URL: $REPO_URL"

          # Determinar la semana - por defecto 1 para testing
          WEEK="1"
          if [[ "${{ contains(github.event.issue.labels.*.name, 'semana2') }}" == "true" ]]; then
            WEEK="2"
          elif [[ "${{ contains(github.event.issue.labels.*.name, 'semana3') }}" == "true" ]]; then
            WEEK="3"
          elif [[ "${{ contains(github.event.issue.labels.*.name, 'semana4') }}" == "true" ]]; then
            WEEK="4"
          fi

          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "Detected week: $WEEK"

      - name: üß™ Ejecutar evaluaci√≥n autom√°tica
        id: evaluate
        run: |
          echo "Ejecutando evaluaci√≥n..."
          echo "Repo: ${{ steps.extract_info.outputs.repo_url }}"
          echo "Week: ${{ steps.extract_info.outputs.week }}"

          python evaluator/run.py \
            --repo-url "${{ steps.extract_info.outputs.repo_url }}" \
            --week "${{ steps.extract_info.outputs.week }}" \
            --format github
        continue-on-error: true

      - name: üìù Comentar resultados en el issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Leer el resultado de la evaluaci√≥n
            let evaluationResult = '';
            try {
              evaluationResult = fs.readFileSync('evaluation_result.md', 'utf8');
            } catch (error) {
              evaluationResult = `
              ## ‚ùå Error en la Evaluaci√≥n
              
              No se pudo completar la evaluaci√≥n autom√°tica. Posibles causas:
              - El repositorio no existe o no es p√∫blico
              - El repositorio no tiene la estructura esperada
              - Error en el sistema de evaluaci√≥n
              
              **Error details:** ${error.message}
              
              **Repo URL:** ${{ steps.extract_info.outputs.repo_url }}
              **Week:** ${{ steps.extract_info.outputs.week }}
              `;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: evaluationResult
            });
